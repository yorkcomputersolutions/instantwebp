<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta lang="en-us" />

        <title>Instant WebP</title>
    </head>

    <body>
        <h1>Instant WebP</h1>

        <ul class="upload-list"></ul>

        <input name="image_upload" type="file" multiple="multiple" accept="image/*" />
        <button class="button convert-images">Convert</button>
        <p id="progress"></p>

        <script>
            /**
             * Uploads the images
             */
            async function mixImages() {
                console.log('MIXING IMAGES');

                let fileInput = document.querySelector('input[name="image_upload"]');
                let files = fileInput.files;

                if (files.length > 0) {
                    const formData = new FormData();
                    Object.values(files)
                        .forEach(file => formData.append('images', file));

                    try {
                        let response = await fetch('/mix', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            let blob = await response.blob();
                            let url = URL.createObjectURL(blob);
                            let a = document.createElement('a');
                            a.href = url;
                            a.download = 'optimized_images.zip';
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            console.log('Request failed. Returned status of ' + response.status);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                } else {
                    console.log('No images selected.');
                }
            }

            function setupProgressListener() {
                const progressElement = document.getElementById('progress');
                const eventSource = new EventSource('/progress');

                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('receiving: ', data);
                    progressElement.innerHTML = `Processing: ${data.processedFiles}/${data.totalFiles} files (${data.file})`;
                };

                eventSource.onerror = function() {
                    progressElement.innerHTML = 'Error receiving progress updates.';
                };
            }

            window.addEventListener('DOMContentLoaded', () => {
                let convertImages = document.querySelector('.convert-images');

                convertImages.addEventListener('click', async () => {
                    setupProgressListener();
                    await mixImages();
                });
            });
        </script>
    </body>
</html>